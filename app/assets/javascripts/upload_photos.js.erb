$(function () {
  (function () {
    var filesUpload = $('.upload_images');
    var fileList = $('.upload_list');
    var addPhotosButton = fileList.find('.add_photos_button');

    var queue = [];
    var ready = true;

    var reader = new FileReader();
    var imageObj = new Image();
    var canvas = $('<canvas width="100" height="100" />').get(0);

    var thumbnailWidth = 100;
    var thumbnailHeight = 100;

    filesUpload.hide();

    addPhotosButton.click(function() {
      filesUpload.trigger('click');
    });

    function generateThumbnails(files) {
      if (typeof files !== 'undefined') {
        for (var i = 0, l = files.length; i < l; i++) {
          var file = files[i];
          if ((/image/i).test(file.type)) {
            var li = $('<li class="thumb"><div class="image"><img src="<%= asset_path 'default-thumbnail.png' %>" width="' + thumbnailWidth + '" height="' + thumbnailHeight + '" /></div><div class="title">' + file.name + '</div><div class="size">' + getReadableFileSizeString(file.size) + '</div></li>');

            li.insertBefore(fileList.find('.add_photos_button'));

            queue.push({
              'file': file,
              'li': li,
            });
          }
        }
      }
    }

    var generateThumbnailsElement = $('#generate_thumbnails');

    setInterval(function() {
      if (generateThumbnailsElement.is(':checked') && ready && queue.length > 0) {
        ready = false;
        generateThumbnail(queue.shift());
      }
    }, 1000);

    function generateThumbnail(item) {
      var file = item.file;
      var li = item.li;
      var img = li.find('img');

      if (typeof(reader) !== 'undefined') {
        reader.onload = function(event) {
          imageObj.onload = function() {
            canvas.getContext('2d').drawImage(imageObj, 0, 0, thumbnailWidth, thumbnailHeight);
            img.get(0).src = canvas.toDataURL();

            imageObj.src = '';
            canvas.getContext('2d').clearRect(0, 0, thumbnailWidth, thumbnailHeight);

            ready = true;
          };
          imageObj.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    function getReadableFileSizeString(fileSizeInBytes) {
        var i = -1;
        var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
        do {
            fileSizeInBytes = fileSizeInBytes / 1024;
            i++;
        } while (fileSizeInBytes > 1024);

        return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
    };

    filesUpload.bind('change', function () {
      generateThumbnails(this.files);
    });

    fileList.bind({
      dragleave: function (event) {
        var target = event.target;

        if (target && target === fileList) {
          $(this).removeClass('over');
        }
        return false;
      },

      dragenter: function (event) {
        $(this).addClass('over');
        return false;
      },

      dragover: function (event) {
        return false;
      },

      drop: function (event) {
        generateThumbnails(event.originalEvent.dataTransfer.files);
        $(this).removeClass('over');
        return false;
      }
    });
  })();
});


